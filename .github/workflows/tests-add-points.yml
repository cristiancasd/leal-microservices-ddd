name: tests-add-points

on: 
  pull_request:
    paths:
      - 'add-points/**'  

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    services:
      kafka:
        image: wurstmeister/kafka:2.12-2.7.0
        ports:
          - 9092:9092
        environment:
          KAFKA_ADVERTISED_HOST_NAME: kafka
          KAFKA_ADVERTISED_PORT: 9092
          KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
        depends-on:
          - zookeeper
      zookeeper:
        image: zookeeper:3.6.3
        ports:
          - 2181:2181

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Waiting to kafka server started
        run: .github/workflows/wait-for-it.sh localhost 9092 -t 60 -- echo "kafka server ready, testing..."

      - name: Run tests
        run: cd add-points && npm install && npm run test:ci
        env:
          AWS_DEFAULT_REGION: us-east-1   
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

